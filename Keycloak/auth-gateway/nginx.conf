server {
  listen 80;

  # Docker's internal DNS resolver
  resolver 127.0.0.11 ipv6=off valid=10s;

  # ---- Keycloak ----
  location /keycloak/ {
  set $kc http://keycloak:8080;
  proxy_pass $kc/keycloak/;

  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-Port $server_port;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}

  # ---- oauth2-proxy endpoints ----
  location /oauth2/ {
    set $o2p http://oauth2-proxy:4180;
    proxy_pass $o2p;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Scheme $scheme;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # ---- internal auth check ----
  location = /oauth2/auth {
    set $o2pauth http://oauth2-proxy:4180;
    proxy_pass $o2pauth/oauth2/auth;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Scheme $scheme;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # ---- Protected ClickHouse UI ----
  location / {
    auth_request /oauth2/auth;
    error_page 401 = /oauth2/start?rd=$scheme://$host$request_uri;

    # EDIT THIS LINE: use your existing clickhouse container name + port
    set $ch http://fragjetzt-staging.mni.thm.de:18123;
    proxy_pass $ch/;

    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }
}

