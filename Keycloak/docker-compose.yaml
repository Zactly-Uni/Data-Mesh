services:
  traefik:
    image: traefik:v3.1
    container_name: traefik-sso
    command:
      - "--api.dashboard=true"
      - "--entrypoints.web.address=:1111"
      #- "--entrypoints.websecure.address=:2222"

      # <<CHANGE_ME: If you want Let's Encrypt, set your email + enable ACME below>>
      # - "--certificatesresolvers.le.acme.email=<<CHANGE_ME_LETSENCRYPT_EMAIL>>"
      # - "--certificatesresolvers.le.acme.storage=/letsencrypt/acme.json"
      # - "--certificatesresolvers.le.acme.httpchallenge=true"
      # - "--certificatesresolvers.le.acme.httpchallenge.entrypoint=web"

      # Use file provider for routers/services since you can't add labels to existing containers:
      - "--providers.file.directory=/etc/traefik/dynamic"
      - "--providers.file.watch=true"

      # optional: access logs are useful
      - "--accesslog=true"
    ports:
      - "1111:1111"
    #  - "2222:2222"
      # optional: dashboard (lock this down if you expose it)
      # - "8088:8080"
    volumes:
      #- "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "./traefik-dynamic:/etc/traefik/dynamic:ro"

      # <<CHANGE_ME: if using Let's Encrypt, you must create and chmod 600 the acme file>>
    #   - "./letsencrypt:/letsencrypt"
    networks:
      - sso_net
      # Attach to external networks (examples below):
      - grafana_default
      - data_net
      - redpanda-interop
      - airbyte_airbyte_internal

  keycloak2:
    image: quay.io/keycloak/keycloak:26.0.7
    container_name: keycloak2
    command: start
    ports:
      - "3333:3333"
    environment:
      # <<CHANGE_ME: Keycloak admin credentials>>
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin

      # Database config (recommended for anything non-trivial)
      KC_DB: postgres
      KC_DB_URL: "jdbc:postgresql://keycloak-db2:5432/keycloak"
      KC_DB_USERNAME: "keycloak"
      KC_DB_PASSWORD: "admin"

      # <<CHANGE_ME: must match your external URL for Keycloak>>
      KC_HOSTNAME: "sso.fragjetzt-staging.mni.thm.de"
      KC_PROXY_HEADERS: "xforwarded"
      KC_HTTP_ENABLED: "true"
      KC_HTTP_PORT: "3333"
      command: start-dev
      #KC_HOSTNAME_STRICT: "true"
      #KC_HOSTNAME_STRICT_HTTPS: "true"

    depends_on:
      - keycloak-db2
    networks:
      - sso_net

  keycloak-db2:
    image: postgres:16
    container_name: keycloak-db2
    environment:
      POSTGRES_DB: "keycloak"
      POSTGRES_USER: "keycloak"
      POSTGRES_PASSWORD: admin
    volumes:
      - keycloak_db_data:/var/lib/postgresql/data
    networks:
      - sso_net

  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.7.1
    container_name: oauth2-proxy
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      # Provider settings
      OAUTH2_PROXY_PROVIDER: "keycloak-oidc"
      # <<CHANGE_ME: your Keycloak issuer URL>>
      OAUTH2_PROXY_OIDC_ISSUER_URL: "http://host.docker.internal:3333/realms/master"

      # <<CHANGE_ME: client ID + secret for oauth2-proxy in Keycloak>>
      OAUTH2_PROXY_CLIENT_ID: "<<CHANGE_ME_OIDC_CLIENT_ID>>"
      OAUTH2_PROXY_CLIENT_SECRET: "<<CHANGE_ME_OIDC_CLIENT_SECRET>>"

      # Cookie/session settings
      # <<CHANGE_ME: generate a 32-byte base64 secret>>
      OAUTH2_PROXY_COOKIE_SECRET: m4u5N6H8fJvGk9nqE2QXcZyD0bM+S7A=
      OAUTH2_PROXY_COOKIE_SECURE: "false"

      # <<CHANGE_ME: set to your parent domain if you want one login shared across subdomains>>
      # Example: ".example.com"
      OAUTH2_PROXY_COOKIE_DOMAINS: ".fragjetzt-staging.mni.thm.de"

      # <<CHANGE_ME: allow the domains you serve>>
      OAUTH2_PROXY_WHITELIST_DOMAINS: ".fragjetzt-staging.mni.thm.de"

      # oauth2-proxy will be used as ForwardAuth endpoint by Traefik
      OAUTH2_PROXY_HTTP_ADDRESS: "0.0.0.0:4180"
      # <<CHANGE_ME: callback must match client redirect URI in Keycloak>>
      OAUTH2_PROXY_REDIRECT_URL: "http://auth.fragjetzt-staging.mni.thm.de:1111/oauth2/callback"

      # You can restrict who can login (optional):
      # <<CHANGE_ME: e.g. your email domain>>
      # OAUTH2_PROXY_EMAIL_DOMAINS: "<<CHANGE_ME_ALLOWED_EMAIL_DOMAIN_OR_*>>"
      OAUTH2_PROXY_EMAIL_DOMAINS: "*"

      # Pass identity to upstream (useful for logs)
      OAUTH2_PROXY_SET_XAUTHREQUEST: "true"
      OAUTH2_PROXY_PASS_ACCESS_TOKEN: "true"
      OAUTH2_PROXY_PASS_AUTHORIZATION_HEADER: "true"
    networks:
      - sso_net
    # no ports exposed; Traefik will call it internally

networks:
  sso_net:
    name: sso_net  # optional; otherwise Docker assigns a name
    driver: bridge

  # External networks: <<CHANGE_ME: replace "name:" with your real docker network names>>
  grafana_default:
    external: true
    name: grafana_default

  data_net:
    external: true
    name: data_net

  redpanda-interop:
    external: true
    name: redpanda-interop

  airbyte_airbyte_internal:
    external: true
    name: airbyte_airbyte_internal

volumes:
  keycloak_db_data:
