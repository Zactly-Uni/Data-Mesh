name: redpanda-cdc-postgres
volumes:
  redpanda-0:
  redpanda-1:
  redpanda-2:
  nifi_conf:
  nifi_database:
  nifi_flowfile:
  nifi_content:
  nifi_provenance:
  pg_data:
services:
  postgres:
    image: debezium/postgres:16
    container_name: postgres
    ports:
      - 5439:5432
    healthcheck:
      test: "pg_isready -U postgresuser -d pandashop"
      interval: 2s
      timeout: 20s
      retries: 10
    environment:
      - POSTGRES_USER=postgresuser
      - POSTGRES_PASSWORD=postgrespw
      - POSTGRES_DB=pandashopf
      - PGPASSWORD=postgrespw
    volumes:
      - pg_data:/var/lib/postgresql/data
    networks:
      - redpanda-interop
  redpanda-0:
    #deploy:
      #resources:
       # limits:
         # memory: 1G
    command:
      - redpanda
      - start
      - --kafka-addr internal://0.0.0.0:9092,external://0.0.0.0:19092
      - --advertise-kafka-addr internal://redpanda-0:9092,external://localhost:19092
      - --pandaproxy-addr internal://0.0.0.0:8082,external://0.0.0.0:18082
      - --advertise-pandaproxy-addr internal://redpanda-0:8082,external://localhost:18082
      - --schema-registry-addr internal://0.0.0.0:8081,external://0.0.0.0:18081
      - --rpc-addr redpanda-0:33145
      - --advertise-rpc-addr redpanda-0:33145
      - --mode dev-container
      - --smp 1
      - --default-log-level=info
      - --seeds redpanda-0:33145,redpanda-1:33145,redpanda-2:33145
    image: docker.redpanda.com/redpandadata/redpanda:${REDPANDA_VERSION:-latest}
    container_name: redpanda-0
    volumes:
      - redpanda-0:/var/lib/redpanda/data
    ports:
      - 18081:18081
      - 18082:18082
      - 19092:19092
      - 19644:9644
    healthcheck:
      test: ["CMD-SHELL", "rpk cluster health | grep -E 'Healthy:.+true' || exit 1"]
      interval: 15s
      timeout: 3s
      retries: 5
      start_period: 5s
    networks:
      - redpanda-interop
  redpanda-1:
    command:
      - redpanda
      - start
      - --kafka-addr internal://0.0.0.0:9092,external://0.0.0.0:29092
      - --advertise-kafka-addr internal://redpanda-1:9092,external://localhost:29092
      - --pandaproxy-addr internal://0.0.0.0:8082,external://0.0.0.0:28082
      - --advertise-pandaproxy-addr internal://redpanda-1:8082,external://localhost:28082
      - --schema-registry-addr internal://0.0.0.0:8081,external://0.0.0.0:28081
      - --rpc-addr redpanda-1:33145
      - --advertise-rpc-addr redpanda-1:33145
      - --mode dev-container
      - --smp 1
      - --default-log-level=info
      - --seeds redpanda-0:33145,redpanda-1:33145,redpanda-2:33145
    image: docker.redpanda.com/redpandadata/redpanda:${REDPANDA_VERSION:-latest}
    container_name: redpanda-1
    volumes:
      - redpanda-1:/var/lib/redpanda/data
    ports:
      - 28081:28081
      - 28082:28082
      - 29092:29092
      - 29644:9644
    
    networks:
      - redpanda-interop
  redpanda-2:
    command:
      - redpanda
      - start
      - --kafka-addr internal://0.0.0.0:9092,external://0.0.0.0:39092
      - --advertise-kafka-addr internal://redpanda-2:9092,external://localhost:39092
      - --pandaproxy-addr internal://0.0.0.0:8082,external://0.0.0.0:38082
      - --advertise-pandaproxy-addr internal://redpanda-2:8082,external://localhost:38082
      - --schema-registry-addr internal://0.0.0.0:8081,external://0.0.0.0:38081
      - --advertise-rpc-addr redpanda-2:33145
      - --mode dev-container
      - --smp 1
      - --default-log-level=info
      - --seeds redpanda-0:33145,redpanda-1:33145,redpanda-2:33145
    image: docker.redpanda.com/redpandadata/redpanda:${REDPANDA_VERSION:-latest}
    container_name: redpanda-2
    volumes:
      - redpanda-2:/var/lib/redpanda/data
    ports:
      - 38081:38081
      - 38082:38082
      - 39092:39092
      - 39644:9644
    
    networks:
      - redpanda-interop
  debezium:
    image: debezium/connect:2.4
    container_name: debezium
    environment:
      BOOTSTRAP_SERVERS: "redpanda-0:9092.redpanda-1:9092,redpanda-2:9092"
      GROUP_ID: 1
      CONFIG_STORAGE_TOPIC: connect_configs
      OFFSET_STORAGE_TOPIC: connect_offsets
    depends_on: [postgres, redpanda-0,redpanda-1,redpanda-2]
    ports:
      - 8083:8083
    networks:
      - redpanda-interop
  console:
    image: redpandadata/console:latest
    container_name: redpanda-console
    restart: on-failure
    ports:
      - "8084:8080"
#    volumes:
 #     - ./console-config.yaml:/etc/redpanda/console-config.yaml

    environment:
  #    CONFIG_FILEPATH: /etc/redpanda/console-config.yaml
      KAFKA_BROKERS: "redpanda-0:9092,redpanda-1:9092,redpanda-2:9092"
      KAFKA_SCHEMAREGISTRY_ENABLED: "true"
      KAFKA_SCHEMAREGISTRY_URLS: "http://redpanda-0:8081"
    depends_on:
      - redpanda-0
      - redpanda-1
      - redpanda-2
    networks:
      - redpanda-interop
  redpanda-connect:
    image: redpandadata/connect:latest
    container_name: redpanda-connect
    depends_on:
      redpanda-0:
        condition: service_healthy
    #hostname: fk-feedback-test.mni.thm.de
    ports:
      - "8384:8080"
    volumes:
      - ./api_server.yaml:/api_server.yaml
      - ./weather_data.yaml:/weather_data.yaml
      - ./autobahn.yaml:/autobahn.yaml
      - ./weatherstations.yaml:/weatherstations.yaml
      - ./stations.json:/stations.json
    command: ["streams", "/api_server.yaml", "/weather_data.yaml", "/autobahn.yaml", "/weatherstations.yaml"]
    networks:
      - redpanda-interop
  nifi:
    image: apache/nifi:latest
    container_name: nifi
    ports:
      - "8090:8080" # HTTPS Port
    environment:
      - NIFI_WEB_HTTPS_HOST=0.0.0.0
      - NIFI_WEB_HTTPS_PORT=""
      - NIFI_WEB_HTTP_PORT=8080
      #- NIFI_WEB_HTTPS_HOST=0.0.0.0
      #- NIFI_WEB_HTTPS_PORT=8090
      - NIFI_WEB_PROXY_HOST=fragjetzt-staging.mni.thm.de:8090
       #'Authentifizierung (Zwingend erforderlich f√ºr neuere Versionen)
      #- SINGLE_USER_CREDENTIALS_USERNAME=admin
      # Mind 12 Zeichen
      #- SINGLE_USER_CREDENTIALS_PASSWORD=meinsehrsicherespasswort123
    volumes:
      # Persistenz der Daten, damit Flows beim Neustart nicht verloren gehen
      - nifi_conf:/opt/nifi/nifi-current/conf
      - nifi_database:/opt/nifi/nifi-current/database_repository
      - nifi_flowfile:/opt/nifi/nifi-current/flowfile_repository
      - nifi_content:/opt/nifi/nifi-current/content_repository
      - nifi_provenance:/opt/nifi/nifi-current/provenance_repository
      - ./Nifi_Data:/opt/nifi/nifi-current/input_data
      - ./start.sh:/opt/nifi/scripts/start.sh:ro
    restart: unless-stopped
    networks:
      - redpanda-interop
  python-runner:
    build: ./py_run
    container_name: py_run
    depends_on:
      redpanda-0:
        condition: service_healthy
    ports:
      - "8509:8501"
    volumes:
      - ./py_run:/app
    networks:
      - redpanda-interop

networks:
  redpanda-interop:
    name: redpanda-interop
    external: true
